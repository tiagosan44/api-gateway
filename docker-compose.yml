version: '3.8'

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  mock-auth:
    image: nginx:alpine
    ports:
      - "8081:80"
    volumes:
      - ./tests/mock-auth:/usr/share/nginx/html
    command: >
      sh -c "echo 'server {
        listen 80;
        location /auth {
          return 200 \"{\\\"token\\\":\\\"mock-token-123\\\"}\";
          add_header Content-Type application/json;
        }
        location /.well-known/openid-configuration {
          return 200 \"{\\\"issuer\\\":\\\"http://mock-auth:80\\\",\\\"jwks_uri\\\":\\\"http://mock-auth:80/.well-known/jwks.json\\\"}\";
          add_header Content-Type application/json;
        }
        location /.well-known/jwks.json {
          return 200 \"{\\\"keys\\\":[]}\";
          add_header Content-Type application/json;
        }
      }' > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"

  gateway:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=info
      - AUTH_TYPE=both
      - RATELIMIT_ALGORITHM=token_bucket
      - RATELIMIT_ENABLED=true
    depends_on:
      redis:
        condition: service_healthy
      mock-auth:
        condition: service_started
    volumes:
      - ./config:/app/config

volumes:
  redis-data:

